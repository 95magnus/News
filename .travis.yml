language: android
sudo: required
jdk: oraclejdk8

before_cache:
 - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
 - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
 directories:
 - $HOME/.gradle/caches/
 - $HOME/.gradle/wrapper/

env:
 global:
 - ANDROID_API=26
 - EMULATOR_API=25
 - ANDROID_BUILD_TOOLS=26.0.2
 - ADB_INSTALL_TIMEOUT=5 # minutes

android:
 components:
 - tools
 - platform-tools
 - build-tools-$ANDROID_BUILD_TOOLS
 - android-$ANDROID_API
 - android-$EMULATOR_API
 - extra-google-m2repository
 - extra-android-m2repository # for design library
 - addon-google_apis-google-$ANDROID_API_LEVEL # google play services
# - sys-img-armeabi-v7a-addon-google_apis-google-$ANDROID_API_LEVEL
# - sys-img-armeabi-v7a-addon-google_apis-google-$EMULATOR_API_LEVEL
 - sys-img-armeabi-v7a-android-$EMULATOR_API

 licenses:
 - android-sdk-preview-license-.+
 - android-sdk-license-.+
 - google-gdk-license-.+

before_install:
- mkdir "$ANDROID_HOME/licenses" || true
- echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
- echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
- chmod +x gradlew
#- ./gradlew dependencies || true # DON'T ADD unless you are getting "Install missing components using SDK manager"
#Source: https://medium.com/@oldergod/constraint-layout-and-circleci-travis-d50342696d2

before_script:
- echo no | android create avd --force -n test -t android-$EMULATOR_API --abi armeabi-v7a
- emulator -avd test -no-skin -no-window &
- android-wait-for-emulator
- adb shell input keyevent 82 &

script:
- "./gradlew clean build connectedCheck -PdisablePreDex --stacktrace"

before_deploy:
- cp $TRAVIS_BUILD_DIR/$STORE_FILE $HOME
- cd app/build/outputs/apk/
- jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore $HOME/$STORE_FILE -storepass $STORE_PASSWORD -keypass $KEYPASSWORD app-release-unsigned.apk $KEY_ALIAS

# Verification
- jarsigner -verify app-release-unsigned.apk
- "${ANDROID_HOME}/build-tools/$ANDROID_BUILD_TOOLS/zipalign -v 4 app-release-unsigned.apk News.apk"

deploy:
  provider: releases
  file: News.apk
  skip_cleanup: true

  on:
    repo: 95magnus/News
    tags: true
    jdk: oraclejdk8
  api_key:
    secure: "a56d5YbbvGUfydjp6FJv2WFuBJ6zDS3mEOdnvqOZRPfBKS7K2yx1fLgwTtav+i2krbg6axb5j8iSsKh/+WrXQA++HMwhQZX92Y3cOlJCX54YH0v/ksdiXhHKKoZHNP97RG8HYLqI/el7pomIwpm4nNtizRpB9mihQ+frF+n4RAfAwl7xOPgOLZBJvmL+vXbkbN+VqszP8fLIVpAZ8vQYfLMAKsPtS1cko3MCmY4gzmXk1PenQFoeGJWQhT5y7zmu7/nejLEvN0WuRfRDp+nDLAv0VrIpGiLhOb0uu4N/BK70uNKFXk9+6oII6r1hH3uWpcw+DA4SRLljjfOAx5k2PJvbqr75Kfpox9eIDVRo80M+K5A+pbmBfh/l9Y7lU4MJQfcVvbdW9vldK6CcmfPdt2ONjvrncaBUGMhiNpI/h4GL2b5TuLkjJKiMa2HsXsfGaKFHtUhp8/VGBfo9I1SVIQ0hq695HkK9ln4GykI95btRK/XI9Npp+06VkvMXo68C4KJcR9tWqCtAuKfxebnGY/pSB7ZAI2jRMGhtRo8HWuEMUwThGwD8Nzg1KnPik/qAr2ZdgaWgbYP7l3fOOeT4aw5fsouecopcqfNeqCahq3d0+ju/qK9gZ99Sj9FBUspGgUON2cIWC5JIwinYOLvwg83VOqS+AsnqayC2kz36p3U="
